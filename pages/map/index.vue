<template>
  <div class="min-h-screen bg-gray-50 flex flex-col">
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div class="bg-white border-b border-gray-200 sticky top-0 z-30">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <div>
            <h1 class="text-xl sm:text-2xl font-bold text-gray-900">
              ‰ºöÂ†¥„Éû„ÉÉ„Éó
            </h1>
            <p class="text-sm text-gray-600 hidden sm:block">
              „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Åó„Åü„Çµ„Éº„ÇØ„É´„ÅÆÈÖçÁΩÆ„ÇíÁ¢∫Ë™ç
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <div class="flex flex-1 relative">
      <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
      <div :class="[
        'fixed sm:static inset-y-0 left-0 z-50 w-80 bg-white border-r border-gray-200 overflow-y-auto transform transition-transform duration-300 ease-in-out',
        sidebarOpen ? 'translate-x-0' : '-translate-x-full sm:translate-x-0'
      ]" style="top: 64px; height: calc(100vh - 64px);">
        <!-- „É¢„Éê„Ç§„É´Áî®„Éò„ÉÉ„ÉÄ„Éº -->
        <div class="sm:hidden flex justify-between items-center p-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ</h2>
          <button @click="closeSidebar" class="p-2 hover:bg-gray-100 rounded-lg text-gray-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <div class="p-4">
          <!-- „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØÁµ±Ë®à -->
          <div class="mb-6">
            <h3 class="text-base font-semibold text-gray-900 mb-3 flex items-center gap-2">
              <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØÁµ±Ë®à
            </h3>
            <div class="grid grid-cols-2 gap-3">
              <div class="text-center p-3 bg-pink-50 rounded-lg">
                <div class="text-xl font-bold text-pink-500">
                  {{ eventBookmarks.length }}
                </div>
                <div class="text-xs text-gray-600">ÂêàË®à</div>
              </div>
              <div class="text-center p-3 bg-blue-50 rounded-lg">
                <div class="text-xl font-bold text-blue-500">
                  {{ getBookmarkCount('check') }}
                </div>
                <div class="text-xs text-gray-600">„ÉÅ„Çß„ÉÉ„ÇØ</div>
              </div>
              <div class="text-center p-3 bg-amber-50 rounded-lg">
                <div class="text-xl font-bold text-amber-600">
                  {{ getBookmarkCount('interested') }}
                </div>
                <div class="text-xs text-gray-600">Ê∞ó„Å´„Å™„Çã</div>
              </div>
              <div class="text-center p-3 bg-red-50 rounded-lg">
                <div class="text-xl font-bold text-red-500">
                  {{ getBookmarkCount('priority') }}
                </div>
                <div class="text-xs text-gray-600">ÂÑ™ÂÖà</div>
              </div>
            </div>
          </div>

          <!-- „Éï„Ç£„É´„Çø„Éº -->
          <div class="mb-6">
            <h3 class="text-base font-semibold text-gray-900 mb-3">üîß Ë°®Á§∫„Éï„Ç£„É´„Çø„Éº</h3>
            <div class="space-y-2">
              <label v-for="category in bookmarkCategories" :key="category.key"
                class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50">
                <input type="checkbox" :value="category.key" v-model="visibleCategories" class="accent-pink-500">
                <span class="text-sm font-medium text-gray-700 flex-1">{{ category.label }}</span>
                <span class="text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-semibold"
                  :style="{ backgroundColor: getCategoryColor(category.key) }">
                  {{ getBookmarkCount(category.key) }}
                </span>
              </label>
            </div>
          </div>

          <!-- „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„É™„Çπ„Éà -->
          <div>
            <h3 class="text-base font-semibold text-gray-900 mb-3 flex items-center gap-2">
              <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Çµ„Éº„ÇØ„É´
            </h3>
            <div class="space-y-2 max-h-96 overflow-y-auto">
              <div v-for="bookmark in filteredBookmarks" :key="bookmark.id" @click="focusOnCircle(bookmark)"
                class="p-3 border border-gray-200 rounded-lg cursor-pointer transition-all duration-200 hover:border-pink-500 hover:bg-pink-50">
                <div class="flex items-center gap-2 mb-1">
                  <div class="w-3 h-3 rounded-full" :style="{ backgroundColor: getCategoryColor(bookmark.category) }">
                  </div>
                  <span class="font-semibold text-sm text-gray-900 truncate">
                    {{ bookmark.circle.circleName }}
                  </span>
                </div>
                <div class="text-xs text-gray-600">
                  {{ formatPlacement(bookmark.circle.placement) }}
                </div>
              </div>

              <div v-if="filteredBookmarks.length === 0" class="text-center py-8 text-gray-500">
                <div class="text-2xl mb-2">üì≠</div>
                <p class="text-sm">Ë°®Á§∫„Åô„Çã„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                <p v-if="eventBookmarks.length === 0" class="text-xs mt-2">ÁèæÂú®„ÅÆ„Ç§„Éô„É≥„Éà„Å´„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- „Çµ„Ç§„Éâ„Éê„Éº„Ç™„Éº„Éê„Éº„É¨„Ç§Ôºà„É¢„Éê„Ç§„É´Ôºâ -->
      <div v-if="sidebarOpen" @click="closeSidebar" class="sm:hidden fixed inset-0 bg-black bg-opacity-50 z-40"></div>

      <!-- „É°„Ç§„É≥„Éû„ÉÉ„Éó„Ç®„É™„Ç¢ -->
      <div class="flex-1 flex flex-col">
        <!-- Êìç‰ΩúË™¨ÊòéÔºà„É¢„Éê„Ç§„É´Áî®Ôºâ -->
        <div class="sm:hidden bg-gray-50 border-b border-gray-200 p-3">
          <div class="text-xs text-gray-600 text-center">
            <span class="flex items-center justify-center gap-3">
              <span class="flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
                </svg>
                „Éî„É≥„ÉÅ„Åß„Ç∫„Éº„É†
              </span>
              <span class="text-gray-400">|</span>
              <span class="flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
                </svg>
                „Éâ„É©„ÉÉ„Ç∞„ÅßÁßªÂãï
              </span>
              <span class="text-gray-400">|</span>
              <span class="flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                „Éî„É≥„Çí„Çø„ÉÉ„Éó„ÅßË©≥Á¥∞
              </span>
            </span>
          </div>
        </div>

        <!-- SVGË°®Á§∫„Ç®„É™„Ç¢ -->
        <div class="flex-1 bg-white border border-gray-200 rounded-lg m-4 flex flex-col"
          style="max-height: calc(100vh - 200px);">
          <!-- „Éò„ÉÉ„ÉÄ„Éº -->
          <div class="flex justify-between items-center p-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">‰ºöÂ†¥„Éû„ÉÉ„Éó</h2>

            <!-- „É¢„Éê„Ç§„É´Áî®„Çµ„Ç§„Éâ„Éê„Éº„Éà„Ç∞„É´ -->
            <button @click="toggleSidebar" class="sm:hidden px-3 py-2 bg-pink-500 text-white rounded-lg text-sm">
              <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              <span>„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ</span>
            </button>
          </div>

          <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ -->
          <div v-if="!svgLoaded && !error" class="flex items-center justify-center h-96">
            <div class="text-center">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500 mx-auto mb-4"></div>
              <p class="text-gray-600">SVG„Éû„ÉÉ„Éó„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
            </div>
          </div>

          <!-- „Ç®„É©„ÉºË°®Á§∫ -->
          <div v-else-if="error" class="flex items-center justify-center h-96">
            <div class="text-center">
              <svg class="w-12 h-12 mx-auto mb-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <p class="text-red-600 font-semibold">„Éû„ÉÉ„Éó„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>
              <p class="text-gray-600 mt-2">{{ error }}</p>
              <button @click="loadSvg" class="mt-4 px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600">
                ÂÜçË©¶Ë°å
              </button>
            </div>
          </div>

          <!-- SVGË°®Á§∫ -->
          <div v-else class="flex flex-col flex-1 overflow-hidden">
            <!-- „Ç∫„Éº„É†„Ç≥„É≥„Éà„É≠„Éº„É´ -->
            <div class="flex gap-2 p-4 border-b border-gray-200">
              <button @click="zoomIn"
                class="px-3 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors text-sm"
                title="„Ç∫„Éº„É†„Ç§„É≥">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
              </button>
              <button @click="zoomOut"
                class="px-3 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors text-sm"
                title="„Ç∫„Éº„É†„Ç¢„Ç¶„Éà">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                </svg>
              </button>
              <button @click="resetZoom"
                class="px-3 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm"
                title="„É™„Çª„ÉÉ„Éà">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
              </button>
              <div class="px-3 py-2 bg-gray-100 rounded-lg text-sm text-gray-700">
                {{ Math.round(zoomLevel * 100) }}%
              </div>
            </div>

            <!-- „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„ÉñSVG„Ç≥„É≥„ÉÜ„Éä -->
            <div ref="mapContainer" class="flex-1 relative overflow-hidden bg-gray-50 select-none"
              style="touch-action: none; min-height: 400px;" @mousedown="startPan" @mousemove="handlePan"
              @mouseup="endPan" @mouseleave="endPan" @wheel="handleZoom" @touchstart="handleTouchStart"
              @touchmove="handleTouchMove" @touchend="handleTouchEnd">
              <!-- Â§âÂΩ¢ÂèØËÉΩ„Å™SVG„Ç≥„É≥„ÉÜ„Éä -->
              <div class="relative" :style="{
                transform: `translate(${panX}px, ${panY}px) scale(${zoomLevel})`,
                transformOrigin: '0 0',
                transition: (isPanning || touchActive) ? 'none' : 'transform 0.2s ease',
                cursor: isPanning ? 'grabbing' : 'grab'
              }">
                <!-- „Éô„Éº„ÇπSVG„Éû„ÉÉ„ÉóÔºà„Éî„É≥„ÅØ„Åì„Åì„Å´Áõ¥Êé•Âüã„ÇÅËæº„Åæ„Çå„ÇãÔºâ -->
                <div ref="svgMapContainer" v-html="svgContent"></div>
              </div>

              <!-- Êìç‰ΩúË™¨Êòé -->
              <div class="absolute bottom-2 left-2 bg-black bg-opacity-75 text-white text-xs rounded px-2 py-1">
                <div class="hidden sm:flex items-center gap-2">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
                  </svg>
                  „Éâ„É©„ÉÉ„Ç∞: ÁßªÂãï | „Éõ„Ç§„Éº„É´: „Ç∫„Éº„É†
                </div>
                <div class="sm:hidden flex items-center gap-2">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
                  </svg>
                  „Éâ„É©„ÉÉ„Ç∞: ÁßªÂãï | „Éî„É≥„ÉÅ: „Ç∫„Éº„É†
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- „Çµ„Éº„ÇØ„É´Ë©≥Á¥∞„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó -->
    <div v-if="selectedCircle"
      class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white rounded-xl shadow-2xl border border-gray-200 z-50 mx-4">
      <div class="p-6">
        <div class="flex justify-between items-start mb-4">
          <h4 class="text-xl font-bold text-gray-900 pr-4">
            {{ selectedCircle.circleName }}
          </h4>
          <button @click="selectedCircle = null" class="p-2 hover:bg-gray-100 rounded-full text-gray-500 flex-shrink-0">
            ‚úï
          </button>
        </div>

        <div class="mb-4">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <p class="font-medium text-gray-700">
              {{ formatPlacement(selectedCircle.placement) }}
            </p>
          </div>
          <p v-if="selectedCircle.circleKana" class="text-sm text-gray-600">
            {{ selectedCircle.circleKana }}
          </p>
        </div>

        <div v-if="selectedCircle.genre && selectedCircle.genre.length" class="mb-4">
          <div class="flex flex-wrap gap-2">
            <span v-for="genre in selectedCircle.genre" :key="genre"
              class="bg-blue-50 text-blue-700 px-2 py-1 rounded-full text-xs font-medium">
              {{ genre }}
            </span>
          </div>
        </div>

        <div v-if="selectedCircle.description" class="mb-4">
          <p class="text-sm text-gray-600 leading-relaxed">
            {{ selectedCircle.description }}
          </p>
        </div>

        <div class="flex gap-3">
          <!-- Â∑°Âõû„Éú„Çø„É≥ -->
          <button
            @click="handleQuickToggleVisited(selectedCircle.id)"
            :class="[
              'px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2',
              getBookmarkByCircleId(selectedCircle.id)?.visited
                ? 'bg-green-500 text-white hover:bg-green-600'
                : 'bg-gray-500 text-white hover:bg-gray-600'
            ]"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            {{ getBookmarkByCircleId(selectedCircle.id)?.visited ? 'Â∑°ÂõûÊ∏à„Åø' : 'Â∑°Âõû„Åó„ÅüÔºü' }}
          </button>

          <NuxtLink :to="`/circles/${selectedCircle.id}`"
            class="flex-1 px-4 py-2 bg-pink-500 text-white rounded-lg text-center font-medium hover:bg-pink-600 transition-colors"
            @click="selectedCircle = null">
            Ë©≥Á¥∞„ÇíË¶ã„Çã
          </NuxtLink>
        </div>
      </div>
    </div>

    <!-- „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div v-if="selectedCircle" @click="selectedCircle = null" class="fixed inset-0 bg-black bg-opacity-50 z-40"></div>

  </div>
</template>

<script setup lang="ts">
// Type imports
import type { Circle, BookmarkCategory, BookmarkWithCircle } from '~/types'
import { useCircleMapping } from '~/composables/useEventMap'
import { useSvgPins } from '~/composables/useSvgPins'

// State
const svgContent = ref<string>('')
const svgLoaded = ref<boolean>(false)
const error = ref<string | null>(null)

// „Ç∫„Éº„É†„Éª„Éë„É≥Èñ¢ÈÄ£„ÅÆstate
const mapContainer = ref<HTMLElement | null>(null)
const svgMapContainer = ref<HTMLElement | null>(null)
const zoomLevel = ref<number>(1)
const panX = ref<number>(0)
const panY = ref<number>(0)
const isPanning = ref<boolean>(false)
const lastPanPoint = ref<{ x: number; y: number }>({ x: 0, y: 0 })

// „Çø„ÉÉ„ÉÅÊìç‰ΩúÈñ¢ÈÄ£
const touchActive = ref<boolean>(false)
const touches = ref<Touch[]>([])
const lastTouchDistance = ref<number>(0)
const lastTouchCenter = ref<{ x: number; y: number }>({ x: 0, y: 0 })

// „Çµ„Ç§„Éâ„Éê„ÉºÈñ¢ÈÄ£
const sidebarOpen = ref<boolean>(false)
const visibleCategories = ref<BookmarkCategory[]>(['check', 'interested', 'priority'])

// ÁèæÂú®„ÅÆ„Ç§„Éô„É≥„ÉàID„ÇíÂèñÂæóÔºàcurrentEvent„ÅåÂà©Áî®ÂèØËÉΩ„Å´„Å™„Çã„Åæ„ÅßÂæÖÊ©üÔºâ
const selectedEventId = computed(() => {
  const eventId = currentEvent.value?.id || 'geica-32'
  logger.debug('üéØ selectedEventId computed:', eventId, currentEvent.value)
  return eventId
})

// Composables
const { bookmarksWithCircles, fetchBookmarksWithCircles, toggleVisited, getBookmarkByCircleId } = useBookmarks()
const logger = useLogger('MapPage')
const { currentEvent, fetchEvents } = useEvents()
const { formatPlacement } = useCircles()
const { getCirclePosition } = useCircleMapping()
const { initializePins, renderPins, highlightPin, resetPinHighlight, clearPins, pinStyles } = useSvgPins({
  radius: 12,
  strokeWidth: 3,
  dropShadow: true,
  animated: true
})

// „Ç∫„Éº„É†Ë®≠ÂÆö
const MIN_ZOOM = 0.5
const MAX_ZOOM = 3
const ZOOM_STEP = 0.2

// „Ç´„ÉÜ„Ç¥„É™Ë®≠ÂÆö
const bookmarkCategories = ref([
  { key: 'check' as BookmarkCategory, label: '„ÉÅ„Çß„ÉÉ„ÇØ‰∫àÂÆö' },
  { key: 'interested' as BookmarkCategory, label: 'Ê∞ó„Å´„Å™„Çã' },
  { key: 'priority' as BookmarkCategory, label: 'ÂÑ™ÂÖà' }
])

// SVGË™≠„ÅøËæº„ÅøÈñ¢Êï∞
const loadSvg = async () => {
  // ÁèæÂú®„ÅÆ„Ç§„Éô„É≥„Éà„Å´Âü∫„Å•„ÅÑ„Å¶„Éû„ÉÉ„Éó„ÇíË™≠„ÅøËæº„ÇÄ
  await loadMapForCurrentEvent()
}

// „Ç∫„Éº„É†Ê©üËÉΩ
const zoomIn = () => {
  const newZoom = Math.min(zoomLevel.value + ZOOM_STEP, MAX_ZOOM)
  zoomLevel.value = newZoom
  logger.debug('üîç „Ç∫„Éº„É†„Ç§„É≥:', newZoom)
}

const zoomOut = () => {
  const newZoom = Math.max(zoomLevel.value - ZOOM_STEP, MIN_ZOOM)
  zoomLevel.value = newZoom
  logger.debug('üîç „Ç∫„Éº„É†„Ç¢„Ç¶„Éà:', newZoom)
}

const resetZoom = () => {
  zoomLevel.value = 1
  centerMap()
  logger.debug('üîÑ „Ç∫„Éº„É†„É™„Çª„ÉÉ„Éà')
}

// „Éû„ÉÉ„Éó‰∏≠Â§ÆÈÖçÁΩÆ
const centerMap = () => {
  if (mapContainer.value) {
    const containerRect = mapContainer.value.getBoundingClientRect()
    panX.value = 0
    panY.value = 0
    logger.info('üìç „Éû„ÉÉ„Éó„Çí‰∏≠Â§ÆÈÖçÁΩÆ:', { containerRect })
  }
}

// „Éû„Ç¶„Çπ„Éõ„Ç§„Éº„É´„Ç∫„Éº„É†
const handleZoom = (event: WheelEvent) => {
  event.preventDefault()

  const delta = event.deltaY > 0 ? -ZOOM_STEP : ZOOM_STEP
  const newZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, zoomLevel.value + delta))

  // „Éû„Ç¶„Çπ‰ΩçÁΩÆ„ÇíÂü∫Ê∫ñ„Å´„Ç∫„Éº„É†ÔºàÂ∞ÜÊù•ÁöÑ„Å™Êã°ÂºµÁî®Ôºâ
  zoomLevel.value = newZoom

  logger.debug('üñ±Ô∏è „Éõ„Ç§„Éº„É´„Ç∫„Éº„É†:', newZoom)
}

// „Éë„É≥Êìç‰ΩúÈñãÂßã
const startPan = (event: MouseEvent) => {
  isPanning.value = true
  lastPanPoint.value = { x: event.clientX, y: event.clientY }
  logger.info('üëÜ „Éë„É≥ÈñãÂßã:', lastPanPoint.value)
}

// „Éë„É≥Êìç‰Ωú‰∏≠
const handlePan = (event: MouseEvent) => {
  if (!isPanning.value) return

  const deltaX = event.clientX - lastPanPoint.value.x
  const deltaY = event.clientY - lastPanPoint.value.y

  panX.value += deltaX
  panY.value += deltaY

  lastPanPoint.value = { x: event.clientX, y: event.clientY }
}

// „Éë„É≥Êìç‰ΩúÁµÇ‰∫Ü
const endPan = () => {
  if (isPanning.value) {
    isPanning.value = false
    logger.info('üëÜ „Éë„É≥ÁµÇ‰∫Ü:', { panX: panX.value, panY: panY.value })
  }
}

// „Çø„ÉÉ„ÉÅÊìç‰ΩúÈñ¢Êï∞
const getTouchDistance = (touch1: Touch, touch2: Touch): number => {
  const dx = touch1.clientX - touch2.clientX
  const dy = touch1.clientY - touch2.clientY
  return Math.sqrt(dx * dx + dy * dy)
}

const getTouchCenter = (touch1: Touch, touch2: Touch): { x: number; y: number } => {
  return {
    x: (touch1.clientX + touch2.clientX) / 2,
    y: (touch1.clientY + touch2.clientY) / 2
  }
}

const handleTouchStart = (event: TouchEvent) => {
  // „Éî„É≥„Åå„Çø„ÉÉ„ÉÅ„Åï„Çå„ÅüÂ†¥Âêà„ÅØÂá¶ÁêÜ„Åó„Å™„ÅÑ
  const target = event.target as Element
  if (target.closest('.bookmark-pin')) {
    return
  }

  event.preventDefault()
  touchActive.value = true
  touches.value = Array.from(event.touches)

  if (touches.value.length === 2) {
    // „Éî„É≥„ÉÅ„Ç∫„Éº„É†ÈñãÂßã
    lastTouchDistance.value = getTouchDistance(touches.value[0], touches.value[1])
    lastTouchCenter.value = getTouchCenter(touches.value[0], touches.value[1])
    logger.info('ü§è „Éî„É≥„ÉÅ„Ç∫„Éº„É†ÈñãÂßã')
  } else if (touches.value.length === 1) {
    // „Éë„É≥ÈñãÂßã
    lastPanPoint.value = {
      x: touches.value[0].clientX,
      y: touches.value[0].clientY
    }
    isPanning.value = true
    logger.info('üëÜ „Çø„ÉÉ„ÉÅ„Éë„É≥ÈñãÂßã')
  }
}

const handleTouchMove = (event: TouchEvent) => {
  // „Éî„É≥„Åå„Çø„ÉÉ„ÉÅ„Åï„Çå„ÅüÂ†¥Âêà„ÅØÂá¶ÁêÜ„Åó„Å™„ÅÑ
  const target = event.target as Element
  if (target.closest('.bookmark-pin')) {
    return
  }

  event.preventDefault()

  if (!touchActive.value) return

  const currentTouches = Array.from(event.touches)

  if (currentTouches.length === 2 && touches.value.length === 2) {
    // „Éî„É≥„ÉÅ„Ç∫„Éº„É†
    const currentDistance = getTouchDistance(currentTouches[0], currentTouches[1])
    const currentCenter = getTouchCenter(currentTouches[0], currentTouches[1])

    if (lastTouchDistance.value > 0) {
      const scale = currentDistance / lastTouchDistance.value
      const newZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, zoomLevel.value * scale))

      // ‰∏≠ÂøÉÁÇπ„ÅÆÁßªÂãï„ÇÇËÄÉÊÖÆ
      const centerDeltaX = currentCenter.x - lastTouchCenter.value.x
      const centerDeltaY = currentCenter.y - lastTouchCenter.value.y

      zoomLevel.value = newZoom
      panX.value += centerDeltaX
      panY.value += centerDeltaY
    }

    lastTouchDistance.value = currentDistance
    lastTouchCenter.value = currentCenter

  } else if (currentTouches.length === 1 && isPanning.value) {
    // „Éë„É≥
    const deltaX = currentTouches[0].clientX - lastPanPoint.value.x
    const deltaY = currentTouches[0].clientY - lastPanPoint.value.y

    panX.value += deltaX
    panY.value += deltaY

    lastPanPoint.value = {
      x: currentTouches[0].clientX,
      y: currentTouches[0].clientY
    }
  }
}

const handleTouchEnd = (event: TouchEvent) => {
  logger.info('üñêÔ∏è „Çø„ÉÉ„ÉÅÁµÇ‰∫Ü')

  if (event.touches.length === 0) {
    touchActive.value = false
    isPanning.value = false
    lastTouchDistance.value = 0
  } else {
    touches.value = Array.from(event.touches)
    if (touches.value.length === 1) {
      // 2Êú¨Êåá„Åã„Çâ1Êú¨Êåá„Å´Â§â„Çè„Å£„ÅüÂ†¥Âêà„ÄÅ„Éë„É≥„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
      isPanning.value = true
      lastPanPoint.value = {
        x: touches.value[0].clientX,
        y: touches.value[0].clientY
      }
    }
  }
}

// „Çµ„Ç§„Éâ„Éê„ÉºÈñ¢Êï∞
const toggleSidebar = () => {
  sidebarOpen.value = !sidebarOpen.value
  logger.info('üì± „Çµ„Ç§„Éâ„Éê„Éº„Éà„Ç∞„É´:', sidebarOpen.value)
}

const closeSidebar = () => {
  sidebarOpen.value = false
}

// „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØÈñ¢ÈÄ£
const eventBookmarks = computed(() => {
  if (!currentEvent.value || !bookmarksWithCircles.value) {
    logger.info('üìä eventBookmarks: empty', { currentEvent: currentEvent.value?.id, bookmarks: bookmarksWithCircles.value?.length })
    return []
  }
  const filtered = bookmarksWithCircles.value.filter(bookmark => bookmark.eventId === currentEvent.value.id)
  logger.info('üìä eventBookmarks computed:', {
    eventId: currentEvent.value.id,
    totalBookmarks: bookmarksWithCircles.value.length,
    eventBookmarks: filtered.length
  })
  return filtered
})

const filteredBookmarks = computed(() => {
  return eventBookmarks.value.filter(bookmark =>
    visibleCategories.value.includes(bookmark.category)
  )
})

// ÊúâÂäπ„Å™„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØÔºàbookmarksWithCircles„Å™„ÅÆ„ÅßÊó¢„Å´„Çµ„Éº„ÇØ„É´ÊÉÖÂ†±„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÔºâ
const validBookmarks = computed(() => {
  return filteredBookmarks.value
})

const getBookmarkCount = (category: BookmarkCategory): number => {
  const count = eventBookmarks.value.filter(bookmark => bookmark.category === category).length
  logger.info('üìä getBookmarkCount:', { category, count, eventBookmarks: eventBookmarks.value.length })
  return count
}

const getCategoryColor = (category: BookmarkCategory): string => {
  return pinStyles.value[category]?.fill || '#6b7280'
}


const focusOnCircle = (bookmark: BookmarkWithCircle) => {
  logger.info('üìç „Çµ„Éº„ÇØ„É´„Å´„Éï„Ç©„Éº„Ç´„Çπ:', bookmark.circle.circleName)
  const position = getCirclePositionForMap(bookmark.circle)

  // „Éû„ÉÉ„Éó„ÇíË©≤ÂΩì„Çµ„Éº„ÇØ„É´„ÅÆ‰ΩçÁΩÆ„Å´ÁßªÂãï
  if (mapContainer.value) {
    const containerWidth = mapContainer.value.clientWidth
    const containerHeight = mapContainer.value.clientHeight

    panX.value = containerWidth / 2 - position.x * zoomLevel.value
    panY.value = containerHeight / 2 - position.y * zoomLevel.value
  }

  // „Éî„É≥„ÇíÂº∑Ë™øË°®Á§∫
  highlightPin(bookmark.id)

  // 3ÁßíÂæå„Å´Âº∑Ë™øË°®Á§∫„Çí„É™„Çª„ÉÉ„Éà
  setTimeout(() => {
    resetPinHighlight()
  }, 3000)

  // „É¢„Éê„Ç§„É´„Åß„Éï„Ç©„Éº„Ç´„ÇπÊôÇ„ÅØ„Çµ„Ç§„Éâ„Éê„Éº„ÇíÈñâ„Åò„Çã
  if (window.innerWidth < 640) {
    closeSidebar()
  }
}

// SVG„Éî„É≥Èñ¢ÈÄ£„ÅÆÊñ∞„Åó„ÅÑÈñ¢Êï∞
const initializeSvgPins = async () => {
  if (!svgMapContainer.value) return

  const svgElement = svgMapContainer.value.querySelector('svg')
  if (svgElement) {
    await initializePins(svgElement)
    logger.info('‚úÖ SVG„Éî„É≥„ÅåÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„Åü')
  } else {
    console.warn('‚ö†Ô∏è SVGË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì')
  }
}

const renderBookmarkPins = async () => {
  if (validBookmarks.value.length === 0) {
    clearPins()
    return
  }

  renderPins(
    validBookmarks.value,
    getCirclePositionForMap,
    showCircleInfo
  )

  logger.info('‚úÖ „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Éî„É≥„ÇíÊèèÁîª„Åó„Åæ„Åó„Åü:', validBookmarks.value.length)
}

// „Çµ„Éº„ÇØ„É´‰ΩçÁΩÆÂèñÂæó
const getCirclePositionForMap = (circle: Circle): { x: number; y: number } => {
  if (!circle) {
    console.warn('ÁÑ°Âäπ„Å™„Çµ„Éº„ÇØ„É´„Éá„Éº„Çø')
    return { x: 400, y: 300 } // „Éá„Éï„Ç©„É´„Éà‰ΩçÁΩÆ
  }
  return getCirclePosition(circle, selectedEventId.value)
}


// „Çµ„Éº„ÇØ„É´Ë©≥Á¥∞Ë°®Á§∫
const selectedCircle = ref<Circle | null>(null)

const showCircleInfo = (circle: Circle) => {
  selectedCircle.value = circle
  logger.info('üìã „Çµ„Éº„ÇØ„É´Ë©≥Á¥∞Ë°®Á§∫:', circle.circleName)
}

// SVG„Éû„ÉÉ„Éó„ÅÆË™≠„ÅøËæº„ÅøÔºàÁèæÂú®„ÅÆ„Ç§„Éô„É≥„Éà„Å´Âü∫„Å•„ÅèÔºâ
const loadMapForCurrentEvent = async () => {
  logger.info('üîÑ „Éû„ÉÉ„ÉóË™≠„ÅøËæº„Åø:', selectedEventId.value)

  // SVG„Éû„ÉÉ„Éó„ÇíÁèæÂú®„ÅÆ„Ç§„Éô„É≥„ÉàÁî®„Å´Ë™≠„ÅøËæº„Åø
  // geica-31,32,33„Å´ÂØæÂøú
  // „Åù„Çå‰ª•Â§ñ„ÅØ„Éá„Éï„Ç©„É´„Éà„Åßgeica-32
  // map-geica31.svg, map-geica32.svg, map-geica33.svg
  const mapFileName = (() => {
    const eventId = selectedEventId.value
    if (['geica-31', 'geica-32', 'geica-33'].includes(eventId)) {
      //eventId„ÅØgeica-31„Å™„ÅÆ„Åßgeica31„Å´Â§âÊèõ
      return `map-${eventId.replace('geica-', 'geica')}.svg`
    }
    return 'map-geica32.svg'
  })()

  try {
    svgLoaded.value = false
    error.value = null

    const response = await fetch(`/${mapFileName}`)
    if (!response.ok) {
      throw new Error(`SVG„Éï„Ç°„Ç§„É´„ÅÆÂèñÂæó„Å´Â§±Êïó: ${response.status} ${response.statusText}`)
    }

    const svgText = await response.text()
    svgContent.value = svgText
    svgLoaded.value = true

    // „Éû„ÉÉ„Éó„Çí‰∏≠Â§ÆÈÖçÁΩÆ„Å®„Éî„É≥ÂÜçÂàùÊúüÂåñ
    nextTick(async () => {
      centerMap()
      await initializeSvgPins()
      await renderBookmarkPins()
    })

    logger.info('‚úÖ „Éû„ÉÉ„ÉóË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', selectedEventId.value)
  } catch (err) {
    console.error('‚ùå „Éû„ÉÉ„ÉóË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', err)
    error.value = err instanceof Error ? err.message : 'Unknown error'
  }
}

// currentEventÂ§âÊõ¥ÊôÇ„ÅÆËá™ÂãïÂàá„ÇäÊõø„ÅàÔºàÂàùÂõû„ÇÇÂê´„ÇÅ„Å¶ÂèçÂøúÔºâ
watch(() => currentEvent.value, async (newEvent, oldEvent) => {
  // newEvent„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØÂ∏∏„Å´Âá¶ÁêÜÔºàÂàùÂõûË°®Á§∫ÊôÇ„ÇÇÂê´„ÇÄÔºâ
  if (newEvent) {
    logger.info('üîÑ „Éû„ÉÉ„Éó„Éö„Éº„Ç∏: „Ç§„Éô„É≥„ÉàÂ§âÊõ¥Ê§úÁü•:', oldEvent?.id, '‚Üí', newEvent.id)

    // „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Éá„Éº„Çø„ÇíÂÜçÂèñÂæó
    await fetchBookmarksWithCircles()
    logger.info('‚úÖ „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Éá„Éº„ÇøÂÜçÂèñÂæóÂÆå‰∫Ü:', bookmarksWithCircles.value?.length || 0)

    // „Éû„ÉÉ„Éó„ÇíÊõ¥Êñ∞
    await loadMapForCurrentEvent()
  }
}, { immediate: true })

// „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØÂ§âÊõ¥ÊôÇ„ÅÆËá™ÂãïÂÜçÊèèÁîª
watch(() => validBookmarks.value, async () => {
  await renderBookmarkPins()
}, { deep: true })

// „Éï„Ç£„É´„Çø„ÉºÂ§âÊõ¥ÊôÇ„ÅÆÂÜçÊèèÁîª
watch(() => visibleCategories.value, async () => {
  await renderBookmarkPins()
}, { deep: true })

// „ÇØ„Ç§„ÉÉ„ÇØÂ∑°ÂõûÊ©üËÉΩ
const handleQuickToggleVisited = async (circleId: string) => {
  try {
    logger.info('üîÑ „ÇØ„Ç§„ÉÉ„ÇØÂ∑°Âõû„Éà„Ç∞„É´:', circleId)
    await toggleVisited(circleId)
    logger.info('‚úÖ „ÇØ„Ç§„ÉÉ„ÇØÂ∑°Âõû„Éà„Ç∞„É´ÂÆå‰∫Ü')
  } catch (error) {
    console.error('‚ùå „ÇØ„Ç§„ÉÉ„ÇØÂ∑°Âõû„Éà„Ç∞„É´„Ç®„É©„Éº:', error)
  }
}

// ÁèæÂú®„ÅÆ„Ç§„Éô„É≥„Éà„ÅåÂà©Áî®ÂèØËÉΩ„Å´„Å™„Çã„Åæ„ÅßÂæÖÊ©ü
const waitForCurrentEvent = async (): Promise<boolean> => {
  let attempts = 0
  const maxAttempts = 50 // 5ÁßíÈñì

  while (!currentEvent.value && attempts < maxAttempts) {
    await new Promise(resolve => setTimeout(resolve, 100))
    attempts++

    if (attempts === 10) {
      // 1ÁßíÂæå„Å´fetchEvents„ÇíË©¶„Åô
      logger.info('üîÑ Attempting to fetch events...')
      try {
        await fetchEvents()
      } catch (error) {
        console.error('‚ùå Failed to fetch events:', error)
      }
    }

    if (attempts % 10 === 0) {
      logger.info(`‚è≥ Still waiting for currentEvent... (${attempts * 100}ms)`)
    }
  }

  return !!currentEvent.value
}

// ÂàùÊúüÂåñ
onMounted(async () => {
  logger.info('üöÄ „Éû„ÉÉ„Éó„Éö„Éº„Ç∏„Åå„Éû„Ç¶„É≥„Éà„Åï„Çå„Åæ„Åó„Åü')
  logger.info('üîç ÂàùÊúücurrentEvent:', currentEvent.value?.id)

  try {
    // „Ç§„Éô„É≥„ÉàÊÉÖÂ†±„ÇíÂèñÂæóÔºà„Åæ„Å†ÂèñÂæó„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÔºâ
    if (!currentEvent.value) {
      await fetchEvents()
    }

    // currentEvent„ÅåË®≠ÂÆö„Åï„Çå„Çã„Åæ„ÅßÂæÖÊ©ü
    const hasCurrentEvent = await waitForCurrentEvent()

    if (!hasCurrentEvent) {
      console.error('‚ùå currentEvent„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì')
      return
    }

    logger.info('‚úÖ currentEventÁ¢∫Ë™çÂÆå‰∫Ü:', currentEvent.value?.id)

    // watcher„Ååimmediate: true„Å™„ÅÆ„Åß„ÄÅ„Åì„Åì„Åß„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
    // watcher„ÅåËá™ÂãïÁöÑ„Å´„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å®„Éû„ÉÉ„Éó„ÇíË™≠„ÅøËæº„ÇÄ

    logger.info('‚úÖ „Éû„ÉÉ„Éó„Éö„Éº„Ç∏ÂàùÊúüÂåñÂÆå‰∫Ü')
  } catch (error) {
    console.error('‚ùå ÂàùÊúüÂåñ„Ç®„É©„Éº:', error)
  }
})

// SEO
useHead({
  title: '‰ºöÂ†¥„Éû„ÉÉ„Éó - geica check!',
  meta: [
    { name: 'description', content: 'SVG„Éû„ÉÉ„Éó„ÅÆË°®Á§∫„ÉÜ„Çπ„Éà„Éö„Éº„Ç∏„Åß„Åô„ÄÇ' }
  ]
})
</script>