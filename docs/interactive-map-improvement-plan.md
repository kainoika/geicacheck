# インタラクティブマップ改善計画

## 概要
このドキュメントは、geika check!のインタラクティブマップ機能における課題と解決策をまとめたものです。

## 現状の課題

### 1. イベントごとに異なるマップデータとサークル情報
- マップデータおよびサークル情報は各イベントごとに異なる
- 新規イベント追加時の対応が煩雑
- ハードコーディングされた部分が多い

### 2. サークル配置番号の表記差異
- マップデータ上: `ア-01`、`ア-02`のような個別表記
- サークル情報上: `ア-01-02`のような範囲表記（2スペース使用を意味する）
- 最大2スペースまで（`ア-01-02-03`のようなケースは考慮不要）

### 3. 端末間でのピン位置ずれ
- PC、スマホなど端末が異なるとマップとピンの位置がずれる
- レスポンシブ対応の難しさ
- 現在のピン表示方式の妥当性への疑問

## 解決策

### 課題1: イベントごとに異なるマップデータとサークル情報

#### 解決策A: イベント設定の外部化
- **概要**: 各イベントごとにJSON/YAMLファイルで設定を管理
- **メリット**: 
  - 新イベント追加が容易
  - コード変更なしで設定変更可能
  - バージョン管理しやすい
- **実装例**:
  ```json
  {
    "eventId": "geika-33",
    "mapFile": "map-geika33.svg",
    "coordinateSystem": {
      "type": "grid",
      "areas": ["カ", "み", "ア", "ド"],
      "mappingRules": {...}
    }
  }
  ```

#### 解決策B: マップエディタツールの開発
- **概要**: 管理者向けのビジュアルマップエディタ
- **機能**:
  - SVG上で直接サークル位置を設定
  - ドラッグ&ドロップでの配置調整
  - 設定データの自動生成・エクスポート
- **メリット**: 技術者以外でも設定可能

#### 解決策C: マップテンプレートシステム
- **概要**: 共通レイアウトパターンをテンプレート化
- **実装方針**:
  - 基本レイアウト（島配置など）をテンプレート化
  - イベントごとの差分のみを定義
  - 継承とオーバーライドで柔軟に対応

### 課題2: サークル配置番号の表記差異

#### 解決策A: 配置番号の正規化処理
- **概要**: 範囲表記を個別配置に変換するパーサー
- **処理フロー**:
  1. `ア-01-02`を入力として受け取る
  2. `[ア-01, ア-02]`の配列に変換
  3. 各配置の座標を計算
  4. 2スペース分の表示を中央配置
- **実装例**:
  ```typescript
  function parsePlacement(placement: string): string[] {
    // "ア-01-02" -> ["ア-01", "ア-02"]
    const match = placement.match(/^(.+)-(\d+)-(\d+)$/);
    if (match) {
      const [_, prefix, start, end] = match;
      return [`${prefix}-${start}`, `${prefix}-${end}`];
    }
    return [placement];
  }
  ```

#### 解決策B: サークル配置モデルの拡張
- **概要**: データモデルで複数スペースを明示的に管理
- **インターフェース設計**:
  ```typescript
  interface CirclePlacement {
    primary: string;      // "ア-01"
    secondary?: string;   // "ア-02" (2スペースの場合)
    displayAs: 'single' | 'double';
    centerPosition?: boolean;
  }
  ```

#### 解決策C: マップデータ側での対応
- **概要**: SVG側で複数スペース情報を保持
- **実装方法**:
  - SVG要素に`data-spaces="2"`属性を追加
  - 複数スペース用の特別な表示領域を定義
  - サークル情報とマップデータの自動マッチング

### 課題3: 端末間でのピン位置ずれ問題

#### 解決策A: SVGネイティブな要素として実装
- **概要**: ピンをSVG内部の要素として直接描画
- **メリット**:
  - viewBoxによる自動スケーリング
  - 座標系の一貫性
  - レスポンシブ対応が自然
- **実装方針**:
  - CSSではなくSVG座標系で完結
  - SVG内でのイベント処理

#### 解決策B: グリッドベースの配置システム
- **概要**: マップを論理的なグリッドに分割
- **実装詳細**:
  - 10x10や20x20のグリッドに分割
  - サークルをグリッド座標で管理
  - 表示時に相対位置を計算
- **メリット**: 端末サイズに依存しない配置

#### 解決策C: 代替的な視覚表現
- **ハイライト方式**:
  - ピンではなくサークル枠を色付け
  - 境界線の太さや色で状態表現
- **オーバーレイ方式**:
  - 半透明の色でサークルエリアを塗りつぶし
  - カテゴリごとに色分け
- **番号バッジ方式**:
  - ブックマーク数を数字バッジで表示
  - 位置精度の要求が低い

#### 解決策D: インタラクティブリスト連動
- **概要**: マップとリストの連動UI
- **動作**:
  - マップは全体俯瞰用
  - 詳細はリストで確認
  - リスト選択でマップ上の位置を強調
- **メリット**: モバイルフレンドリー

#### 解決策E: プログレッシブエンハンスメント
- **レベル1（基本）**: テキストベースの配置情報
- **レベル2（中級）**: 静的マップ画像with位置マーカー
- **レベル3（上級）**: フルインタラクティブマップ
- **判定基準**: 端末性能、画面サイズ、ネットワーク速度

## 推奨実装計画

### フェーズ1（短期: 1-2週間）
1. **配置番号の正規化処理**（課題2-解決策A）
   - 既存コードへの影響が最小限
   - すぐに効果が見込める

2. **SVGネイティブ実装への移行**（課題3-解決策A）
   - 位置ずれ問題の根本解決
   - 既存のSVG資産を活用

### フェーズ2（中期: 1ヶ月）
1. **イベント設定の外部化**（課題1-解決策A）
   - 設定ファイルフォーマットの設計
   - 既存イベントの移行

2. **代替視覚表現の実装**（課題3-解決策C）
   - ユーザビリティテストの実施
   - A/Bテストでの効果測定

### フェーズ3（長期: 2-3ヶ月）
1. **マップエディタツール**（課題1-解決策B）
   - 運営チームの要望を反映
   - 将来的なメンテナンス性向上

2. **プログレッシブエンハンスメント**（課題3-解決策E）
   - パフォーマンス最適化
   - 幅広い端末対応

## 技術的考慮事項

### パフォーマンス
- SVGファイルサイズの最適化
- 遅延読み込みの実装
- キャッシュ戦略の見直し

### アクセシビリティ
- スクリーンリーダー対応
- キーボードナビゲーション
- 高コントラストモード

### 保守性
- テスト自動化の拡充
- ドキュメントの整備
- エラーハンドリングの強化

## まとめ

本改善計画により、以下の効果が期待できます：

1. **運用効率の向上**: 新イベント追加が容易に
2. **ユーザビリティ向上**: 端末問わず快適な操作
3. **保守性向上**: 設定の外部化とモジュール化

段階的な実装により、リスクを最小化しながら着実な改善を進めることができます。